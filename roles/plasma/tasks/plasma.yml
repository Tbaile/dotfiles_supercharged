- name: Handle Pacman DE installation
  become: true
  when: ansible_pkg_mgr == "pacman"
  block:
    - name: Install Desktop Environment and applications
      community.general.pacman:
        name:
          - plasma-meta
          - ark
          - dolphin
          - kate
          - spectacle
          - ttf-joypixels
          - ttf-dejavu
          - noto-fonts
          - latte-dock

    - name: Install optional application deps as deps
      community.general.pacman:
        name:
          - unrar
          - unarchiver
          - ffmpegthumbs
          - kdegraphics-thumbnailers
        reason: dependency

- name: Plasma configuration
  notify: 'restart sddm'
  block:
    - name: Set global configuration
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/kdeglobals"
        section: KDE
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        mode: 0644
        no_extra_spaces: true
      loop:
        - { option: "LookAndFeelPackage", value: "org.kde.breezedark.desktop" }
        - { option: "SingleClick", value: "false" }

    - name: Set virtual Desktops
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/kwinrc"
        section: "{{ item.section }}"
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        mode: 0644
        no_extra_spaces: true
      loop:
        - { section: "Desktops", option: "Number", value: "6" }
        - { section: "Desktops", option: "Rows", value: "2" }
        - { section: "Windows", option: "RollOverDesktops", value: "true" }

    - name: Set keyboard layout for KDE
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/kxkbrc"
        section: Layout
        option: "Model"
        value: "dell"
        mode: 0644
        no_extra_spaces: true

    - name: Configure Modules
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/kded5rc"
        section: "{{ item.section }}"
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        mode: 0644
        no_extra_spaces: true
      loop:
        - { section: "Module-browserintegrationreminder", option: "autoload", value: "false" }
        - { section: "Module-device_automounter", option: "autoload", value: "false" }

    - name: Set Default shutdown option
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/ksmserverrc"
        section: General
        option: shutdownType
        value: "2"
        mode: 0644
        no_extra_spaces: true

    - name: Set Default Keybindings
      community.general.ini_file:
        path: "/home/{{ ansible_user_id }}/.config/kglobalshortcutsrc"
        section: "kwin"
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        mode: 0644
        no_extra_spaces: true
      loop: "{{ keybindings }}"

    - name: Copy Desktop Configuration
      ansible.builtin.copy:
        src: "config/plasma-org.kde.plasma.desktop-appletsrc"
        dest: "/home/{{ ansible_user_id }}/.config/plasma-org.kde.plasma.desktop-appletsrc"
        mode: 0600
